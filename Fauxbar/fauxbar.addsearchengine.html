<html>
<head>
	<title>fauxbar.popup</title>
	<link href="fauxbar.css" media="screen" rel="stylesheet" type="text/css" />
	<script type="text/javascript" src="jquery-1.6.2.min.js"></script>
	<script type="text/javascript" src="common.js"></script>
	<script type="text/javascript">
		chrome.tabs.getSelected(null, function(tab){
			chrome.tabs.executeScript(tab.id, {file:"addos.js"});
		});

		chrome.extension.onRequest.addListener(function(message, sender){
			if (message.contents && message.contents == "openSearchInfo") {
				window.openSearchInfo = message;
				chrome.tabs.getSelected(null, function(tab){
					$("img").attr("src", "chrome://favicon/"+tab.url);
				});
				$("b").html(message.title);
				if (message.improper && message.improper == true) {
					$("#note").html('<br />Fauxbar <i>thinks</i> this site has a search engine it can use,<Br />but with no <a style="color:#0066cc" href="http://www.opensearch.org/Home" target="_new">OpenSearch</a> declaration, it\'s hard to tell.<br /><span style="position:relative;top:6px">As such, searching this site via Fauxbar may deliver<br />unexpected results, but feel free to give it a go.</span>');
				}
				else {
					$("#note").html('<br />This site can be used as a Fauxbar search engine.');
				}
				$("html").css("height", $("body").outerHeight()+"px");
				$("body").css("opacity",1);
			}
		});

		function broadcastClosure() {
			chrome.extension.sendRequest({
				action:'waitingToClose',
				hostname:window.openSearchInfo.hostname,
				tabid: window.tab.id
			});
			setTimeout(broadcastClosure, 50);
		}

		function add() {
			chrome.tabs.getSelected(null, function(tab){
				window.tab = tab;
			});

			$("button").prop("disabled",true);
			if (window.openSearchInfo.improper && window.openSearchInfo.improper == true) {
				if (openDb()) {
					window.db.transaction(function(tx){
						tx.executeSql('DELETE FROM opensearches WHERE shortname = ?', [window.openSearchInfo.title]);
						var insertBits = [window.openSearchInfo.title, window.openSearchInfo.currentUrl, window.openSearchInfo.actionAttr, '', '', 0, window.openSearchInfo.method]
						tx.executeSql('INSERT INTO opensearches (shortname, iconurl, searchurl, xmlurl, xml, isdefault, method) VALUES (?, ?, ?, ?, ?, ?, ?)', insertBits);
						$("#buttons").html('<button class="close">OK</button>');
						$("button.close").focus();
						$("#maintext").html('"<b style="font-size:inherit">'+window.openSearchInfo.title+'</b>" has been added to Fauxbar.');
						$("#note").html('<br />This site can now be used as a Fauxbar search engine,<br />knock on wood.');
						broadcastClosure();
					}, errorHandler);
				}
			}
			else {
				var urlToGet = window.openSearchInfo.href;
				if (urlToGet.substr(0,4) != 'http') {
					var urlParts = explode("/", window.openSearchInfo.currentUrl);
					var newUrl = urlParts[0]+'//'+urlParts[2];
					if (urlToGet.substr(0,1) != '/') {
						newUrl += '/';
					}
					urlToGet = newUrl + urlToGet;
				}
				window.urlToGet = urlToGet;
				$.ajax({
					type: "GET",
					url: urlToGet,
					dataType: "xml",
					success: function(xml){
						window.responseXml = xml;
						if (openDb()) {
							chrome.tabs.getSelected(null, function(tab){
								window.tab = tab;
								window.db.transaction(function(tx){
									var method = 'get';
									if ($('Url',xml).attr("method") && $('Url',xml).attr("method").length > 0) {
										method = $('Url',xml).attr("method");
									}

									var suggestUrl = "";
									if ($('Url[type="application/x-suggestions+json"]',xml) && $('Url[type="application/x-suggestions+json"]',xml).attr("template") && strstr($('Url[type="application/x-suggestions+json"]',xml).attr("template"), "{searchTerms}")) {
										suggestUrl = $('Url[type="application/x-suggestions+json"]',xml).attr("template");
									}

									var insertBits = [$("ShortName",xml).text(), window.tab.url, $("Url",xml).attr("template"), window.urlToGet, (new XMLSerializer()).serializeToString(window.responseXml), 0, method, suggestUrl]
									tx.executeSql('DELETE FROM opensearches WHERE shortname = ?', [$("ShortName",xml).text()]);
									tx.executeSql('INSERT INTO opensearches (shortname, iconurl, searchurl, xmlurl, xml, isdefault, method, suggestUrl) VALUES (?, ?, ?, ?, ?, ?, ?, ?)', insertBits);
									// success!
									$("#buttons").html('<button class="close">OK</button>');
									$("button.close").focus();
									$("#maintext").html('"<b style="font-size:inherit">'+window.openSearchInfo.title+'</b>" has been added to Fauxbar.');
									$("#note").html('<br />This site can now be used as a Fauxbar search engine.');
									broadcastClosure();
								}, errorHandler);
							});
						}
					}
				});
			}
		}

		$(".close").live("click", function(){
			chrome.tabs.getSelected(null, function(tab){
				chrome.tabs.update(tab.id, {selected:true});
			});
		});

		$(document).ready(function(){
			$("#add").focus();
			$("style").append(' * { font-family:'+(window.OS == "Mac" ? 'Lucida Grande, ' : '')+' Segoe UI, Arial, sans-serif; }');
		});

	</script>
	<style type="text/css">
		* { font-family: Segoe UI, Arial, sans-serif; font-size:12px; }
		img { height:16px; width:16px; position:relative; top:2px; padding-right:2px; }
		body { background-color:#fff; padding:0; opacity:0; padding:0; height:1px; }
		button { margin-right:0; margin-left:4px; }
		#note { color:rgba(0,0,0,.73); position:relative; top:12px; }
	</style>
</head>
<body>
	<div style="padding:10px 12px 0px 10px;" id="popup">
		<div style="white-space:nowrap;"><img /> <span id="maintext" style="font-size:13px; font-weight:bold">Add "<b style="font-size:inherit"></b>" to Fauxbar?</span><span id="note"></span></div>
		<div id="buttons" style="text-align:right; position:relative; top:30px; padding-bottom:10px">
			<button id="add" onclick="add()">Add to Fauxbar</button>
			<button class="close">Cancel</button>
		</div>
	</div>
</body>
</html>